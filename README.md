# SimpleSfM ユーザーマニュアル

![SimpleSfM Logo](logo.png)

**バージョン 1.0.0**

## 目次

1. [はじめに](#1-はじめに)
2. [インストール方法](#2-インストール方法)
3. [基本的な使い方](#3-基本的な使い方)
4. [高度な設定](#4-高度な設定)
5. [拡張機能](#5-拡張機能)
   - [RAW/WEBP/動画対応](#51-rawwebp動画対応)
   - [空間メディア対応](#52-空間メディア対応)
6. [トラブルシューティング](#6-トラブルシューティング)
7. [よくある質問](#7-よくある質問)
8. [付録](#8-付録)

---

## 1. はじめに

SimpleSfMは、写真から3Dモデルを生成するためのフォトグラメトリーアプリケーションです。複数の角度から撮影された画像を解析し、3次元のモデルを自動的に生成します。

### 1.1 フォトグラメトリーとは

フォトグラメトリー（Photogrammetry）は、複数の写真から対象物の3D形状を復元する技術です。SimpleSfMでは、Structure from Motion（SfM）とMulti-View Stereo（MVS）という2つの主要技術を組み合わせて使用しています。

### 1.2 主な機能

- 複数画像からのカメラ位置推定と3D点群生成
- 高密度点群の生成
- 3Dメッシュの生成
- RAW形式、WEBP形式、動画ファイルからの画像抽出（拡張機能）
- Insta360やXREALなどの空間メディアからの3Dモデル生成（拡張機能）

---

## 2. インストール方法

### 2.1 システム要件

**最小要件:**
- OS: Windows 10/11、macOS 10.14以降、Linux (Ubuntu 18.04以降など)
- CPU: 4コア以上
- メモリ: 8GB以上
- グラフィック: OpenGL 3.3対応グラフィックカード
- ストレージ: 5GB以上の空き容量

**推奨要件:**
- CPU: 8コア以上
- メモリ: 16GB以上
- グラフィック: 4GB以上のVRAMを持つGPU
- ストレージ: SSD 20GB以上の空き容量

### 2.2 インストール手順

#### Linuxの場合

1. 提供されているインストールスクリプトを使用してインストール：

```bash
wget https://example.com/simpleSfM/install.sh
chmod +x install.sh
./extensions-install.sh
```

または、ソースコードからインストールする場合：

```bash
git clone https://github.com/example/simpleSfM.git
cd simpleSfM
./extensions-install.sh
```

#### Windowsの場合

ソースコードからインストールする場合：

```ps1
git clone https://github.com/example/simpleSfM.git
cd simpleSfM
./extensions-install-win.ps1
```

### 2.3 拡張機能のインストール

RAW/WEBP/動画対応や空間メディア対応などの拡張機能をインストールする場合は、インストール時に関連オプションを選択するか、後からインストールスクリプトを実行してください。

```bash
./extensions-install.sh
```

---

## 3. 基本的な使い方

### 3.1 画像の撮影方法

良い3Dモデルを生成するための撮影のコツ：

1. **重なりを持たせる**: 各写真は、前後の写真と約60〜80%の重なりを持たせてください
2. **照明**: 一定の照明条件で撮影してください。フラッシュの使用は避け、自然光や拡散照明が理想的です
3. **対象物の配置**: 対象物が360度見渡せるように配置し、複数の角度から撮影してください
4. **シャープな画像**: 手ブレやピンボケを避け、シャープな画像を撮影してください
5. **反射面や透明な部分**: 光沢のある反射面や透明な部分は再構成が難しいため、必要に応じて一時的にマットな素材で覆うことを検討してください

### 3.2 基本操作

#### 3.2.1 画像の読み込み

1. アプリケーションを起動します
2. 「ファイル」→「画像フォルダを開く...」を選択するか、メインツールバーの「画像フォルダを選択」ボタンをクリック
3. 撮影した画像が保存されているフォルダを選択します
4. 画像が読み込まれると、左側のリストに表示されます

#### 3.2.2 出力フォルダの設定

1. 「出力フォルダ: 」の横にある「選択」ボタンをクリック
2. 3Dモデルなどの結果を保存するフォルダを選択します

#### 3.2.3 処理の実行

以下の3つの処理モードがあります：

1. **画像をアライン**: カメラ位置の推定とスパースな3D点群の生成のみを行います（素早く結果を確認したい場合に便利）
2. **デンス点群を構築**: スパース点群からより詳細な高密度点群を生成します
3. **3Dモデルを生成**: 画像のアライン、デンス点群の構築、3Dメッシュの生成をすべて一度に行います

通常は「3Dモデルを生成」ボタンをクリックして一連の処理を実行するのが簡単です。

#### 3.2.4 処理結果の確認

処理が完了すると、自動的に「モデルビュー」タブに切り替わり、生成された3Dモデルが表示されます。

- **表示モード**: ドロップダウンメニューから異なる表示モード（シェード、ワイヤーフレーム、テクスチャ、点群）を選択できます
- **ビューをリセット**: カメラ位置をデフォルトに戻します
- **エクスポート**: 生成されたモデルを別の形式（OBJ, PLY, STL）でエクスポートできます

### 3.3 処理設定

ワークフロータブの「高度な設定」セクションで以下の設定を調整できます：

- **処理品質**: 低（速い）、中（バランス）、高（遅いが高品質）から選択できます
- **最大画像サイズ**: 処理時に画像をリサイズする最大サイズを設定できます（大きいほど高品質ですが処理時間とメモリ使用量が増加）
- **使用CPUスレッド**: 並列処理に使用するCPUコア数を設定できます

---

## 4. 高度な設定

### 4.1 品質設定の詳細

各品質設定の詳細なパラメータは以下の通りです：

| 設定項目 | 低 (速い) | 中 (バランス) | 高 (遅い) |
|---------|----------|--------------|----------|
| 特徴点数 | 3,000    | 5,000        | 8,000    |
| MVS画像サイズ | 1,000px | 1,500px    | 2,000px  |
| ポアソン深度 | 7        | 8            | 9        |

### 4.2 処理のステップと詳細設定

3Dモデル生成は以下のステップで行われます：

1. **特徴抽出**: 各画像から特徴点を抽出します
2. **特徴マッチング**: 異なる画像間で対応する特徴点を見つけます
3. **スパース再構成**: カメラ位置と初期的な3D点群を推定します
4. **デンス再構成**: より密な点群を生成します
5. **メッシュ生成**: 点群からポリゴンメッシュを生成します

「詳細設定」タブでは以下の高度なオプションを設定できます：

- **GPUを使用する**: 処理の一部をGPUで実行してパフォーマンスを向上させます
- **テクスチャを生成**: メッシュにテクスチャを適用します
- **メッシュを自動簡略化**: モデルの複雑さを調整して表示パフォーマンスを向上させます

### 4.3 大量の画像を処理する方法

大量の画像（例：100枚以上）を処理する場合は以下の方法を参考にしてください：

1. **画像のリサイズ**: 最大画像サイズを2000px程度に設定してメモリ使用量を削減
2. **バッチ処理**: 画像を複数のグループに分けて別々に処理し、後で結合することを検討
3. **品質設定の調整**: 初めは「低」または「中」品質で処理し、結果に問題がなければ「高」品質で再処理

---

## 5. 拡張機能

### 5.1 RAW/WEBP/動画対応

この拡張機能により、通常のJPG/PNG画像だけでなく、以下のメディア形式からも3Dモデルを生成できるようになります：

- RAW形式（ARW, CR2, CR3, DNG, NEF, ORF, RAF, RW2など）
- WEBPファイル（静止画およびアニメーション）
- 動画ファイル（MP4, MOV, AVI, MKVなど）

#### 5.1.1 RAW/WEBP/動画のインポート

1. メインメニューから「ファイル」→「RAW/WEBP/動画をインポート...」を選択
2. 処理するファイルまたはフォルダを選択
3. 出力設定（フォーマット、サイズ、品質）を調整
4. 動画ファイルの場合、抽出するフレームレートと最大フレーム数を設定
5. 「処理開始」ボタンをクリックしてメディアを処理

処理が完了すると、画像として抽出されたファイルが自動的にSimpleSfMに読み込まれます。

#### 5.1.2 動画からの3Dモデル作成のコツ

1. **カメラの動き**: 対象物の周りをゆっくりと、一定の速度で移動させてください
2. **フレームレート**: 通常は1fps程度の設定で十分です
3. **照明**: 一定の照明条件で撮影してください
4. **背景**: 可能であれば、特徴的な背景の前で撮影すると、カメラ位置の推定が向上します

### 5.2 空間メディア対応

この拡張機能は、Insta360やXREALなどの空間撮影デバイスで撮影されたコンテンツから3Dモデルを生成することができます。

#### 5.2.1 対応フォーマット

- **Insta360**: .insp（静止画）、.insv（動画）、360度メタデータを含むJPG/MP4
- **XREAL**: 空間メタデータを含む標準形式（MP4など）
- **その他の360度カメラ**: 360度メタデータを含む標準画像・動画形式

#### 5.2.2 空間メディアのインポート

1. メインメニューから「メディア」→「空間メディアをインポート...」を選択
2. メディアタイプ（Insta360, XREAL/空間動画, その他360度メディア）を選択
3. 処理するファイルまたはフォルダを選択
4. 出力設定を調整
5. 詳細設定タブで360度処理オプションとステレオ処理オプションを設定
6. 「処理開始」ボタンをクリックしてメディアを処理

#### 5.2.3 空間メディアの処理

空間メディアは以下のように処理されます：

1. **等距円筒図法変換**: 360度画像を複数の平面透視投影画像に変換
2. **ステレオ分割**: ステレオコンテンツの場合、左右の視点に分離
3. **標準的なフォトグラメトリー処理**: 変換された画像を使用して3Dモデルを生成

---

## 6. トラブルシューティング

### 6.1 一般的な問題と解決策

| 問題 | 考えられる原因 | 解決策 |
|------|--------------|-------|
| アプリケーションが起動しない | 依存ライブラリの不足 | インストールスクリプトを再実行し、必要なライブラリをインストール |
| メモリ不足エラーが発生する | 画像サイズが大きすぎる | 最大画像サイズを小さく設定し、低品質設定で試す |
| カメラ位置推定に失敗する | 画像間の重なりが不十分 | より多くの画像を撮影し、十分な重なりを確保する |
| モデルに穴や欠損がある | 一部の角度からの画像が不足 | 対象物の全ての面を撮影するよう注意する |
| テクスチャが粗い | 画像解像度が低い、または品質設定が低い | 高解像度の画像を使用し、高品質設定で処理する |
| 処理が途中で停止する | システムリソースの不足 | 不要なアプリケーションを終了し、スワップ領域を増やす |
| エクスポートしたモデルが他のソフトで開けない | 互換性の問題 | 異なる形式（OBJ, PLY, STL）でエクスポートし直す |

### 6.2 エラーメッセージとその対処法

| エラーメッセージ | 意味 | 対処法 |
|----------------|------|-------|
| "スパース再構成に失敗しました" | カメラ位置の推定ができなかった | 画像の重なりを確認し、画像数を増やす |
| "メモリ不足です" | システムのメモリが不足している | 画像サイズを小さく設定し、不要なアプリケーションを終了 |
| "GPUを初期化できません" | GPUドライバの問題 | グラフィックドライバを更新するか、GPU使用をオフにする |
| "ファイルにアクセスできません" | 権限の問題またはファイルロック | アプリケーションを管理者権限で実行するか、出力フォルダの権限を確認 |

### 6.3 パフォーマンス最適化

処理速度とメモリ使用量を最適化するためのヒント：

1. **最大画像サイズ**: 必要以上に大きな値を設定しない（通常は2000〜3000pxで十分）
2. **使用CPUスレッド**: 使用可能なコア数の75％程度を推奨（全コアを使用するとシステムが応答しなくなる可能性）
3. **一時ファイル**: 十分な空き容量のあるSSDに一時ファイルを保存すると速度が向上
4. **バックグラウンドプロセス**: 処理中は不要なアプリケーションを終了する

---

## 7. よくある質問

### 7.1 一般的な質問

**Q: 何枚の画像が必要ですか？**  
A: 対象物の複雑さによりますが、通常は20〜100枚が理想的です。シンプルな対象物なら20〜30枚、複雑な対象物なら50〜100枚を推奨します。

**Q: どのような画像形式がサポートされていますか？**  
A: 標準では JPG, JPEG, PNG, TIF, TIFF をサポートしています。拡張機能をインストールすると、RAW形式、WEBP、動画ファイルにも対応します。

**Q: 処理にどれくらい時間がかかりますか？**  
A: 画像の枚数、解像度、品質設定、コンピュータのスペックによって大きく異なります。数十枚の画像なら通常10分〜1時間程度、数百枚の画像なら数時間かかることもあります。

**Q: 生成されたモデルを他のソフトウェアで使用できますか？**  
A: はい、OBJ, PLY, STL形式でエクスポートでき、Blender, MeshLab, Unity, Unreal Engineなど多くの3Dソフトウェアで利用できます。

**Q: モバイルデバイスの写真でも良い結果が得られますか？**  
A: はい、現代のスマートフォンカメラでも十分な品質の画像が撮影できます。重要なのは、シャープな画像を撮影し、十分な重なりを持たせることです。

### 7.2 拡張機能に関する質問

**Q: RAW画像を使う利点は何ですか？**  
A: RAW画像には圧縮による劣化がなく、より多くの情報が含まれているため、高品質なテクスチャや詳細なジオメトリが得られる可能性があります。ただし、処理時間とメモリ使用量が増加します。

**Q: どのような動画が3Dモデル生成に適していますか？**  
A: 対象物の周りをゆっくりと一定速度で移動しながら撮影した動画が最も適しています。動きのブレが少なく、十分な重なりを持つフレームが含まれる必要があります。

**Q: Insta360のどのモデルがサポートされていますか？**  
A: 基本的にすべてのInsta360モデル（One X, One R, Pro, Proなど）がサポートされています。重要なのはファイル形式（.insp, .insv）または360度メタデータです。

**Q: XREALの空間録画からも3Dモデルを作れますか？**  
A: はい、XREAL Air/Lightで撮影された空間録画から3Dモデルを生成できます。空間メタデータが含まれている場合はより良い結果が得られます。

---

## 8. 付録

### 8.1 システム要件詳細

詳細なシステム要件については、使用する画像の枚数や解像度によって異なります：

| 画像数 | 画像解像度 | 推奨CPU | 推奨メモリ | 推奨ストレージ |
|-------|-----------|---------|-----------|--------------|
| 〜50枚 | 〜2000px  | 4コア以上 | 8GB以上    | 10GB以上の空き容量 |
| 〜100枚 | 〜3000px | 6コア以上 | 16GB以上   | 20GB以上の空き容量 |
| 〜200枚 | 〜4000px | 8コア以上 | 32GB以上   | 40GB以上の空き容量 |
| 200枚〜 | 4000px〜 | 12コア以上 | 64GB以上  | 100GB以上の空き容量 |

### 8.2 コマンドラインオプション

SimpleSfMはコマンドラインからも実行できます：

```bash
# 基本的な使用方法
python simpleSfM.py [オプション]

# 使用可能なオプション
--input, -i        入力画像のディレクトリ
--output, -o       出力ディレクトリ
--quality, -q      処理品質 (low, medium, high)
--max-size, -s     最大画像サイズ（ピクセル）
--threads, -t      使用するCPUスレッド数
--gpu              GPUを使用する（--no-gpuで無効化）
--batch            バッチモードで実行（UIを表示せず）

# 例
python simpleSfM.py -i /path/to/images -o /path/to/output -q medium -s 2000 -t 4
```

### 8.3 技術情報

SimpleSfMは以下の主要なライブラリとアルゴリズムを使用しています：

- **COLMAP**: Structure-from-Motion（SfM）とMulti-View Stereo（MVS）のための堅牢なライブラリ
- **OpenCV**: コンピュータビジョン関連のタスクに使用
- **Open3D**: 3D点群処理とメッシュ生成に使用
- **PyQt5**: グラフィカルユーザーインターフェースの構築に使用

使用されている主なアルゴリズム：

- **SIFT**: Scale-Invariant Feature Transform、特徴点の抽出に使用
- **SfM**: Structure from Motion、カメラ位置と疎な3D点群の推定に使用
- **PatchMatch Stereo**: 密な点群の生成に使用
- **Poisson Surface Reconstruction**: 点群からメッシュを生成するために使用

### 8.4 参考資料

- [GitHub リポジトリ](https://github.com/example/simpleSfM)

### 8.5 ライセンス情報

SimpleSfMは [MIT License](https://opensource.org/licenses/MIT) の下で提供されています。詳細についてはLICENSEファイルを参照してください。

---

拡張機能について詳しく説明します。SimpleSfMには、基本アプリケーションを拡張する2つの主要な拡張モジュールが含まれています：

## 1. RAW/WEBP/動画対応拡張モジュール（media_processor.py）

このモジュールは、標準的な画像形式以外のメディアファイルを処理して、フォトグラメトリーに使用できる画像に変換する機能を提供します。

### 主な機能

1. **RAWファイル処理**
   - カメラの生データである様々なRAW形式（ARW, CR2, DNG, NEF, ORF, RAFなど）を処理
   - rawpyライブラリを使用して最適なホワイトバランスと露出で画像を抽出
   - 高品質なテクスチャや詳細なジオメトリを取得するための情報量の多いソース

2. **WEBPファイル処理**
   - 静止画WEBPファイルの処理
   - アニメーションWEBPからの最初のフレーム抽出
   - PILライブラリを使用した効率的な処理

3. **動画ファイル処理**
   - MP4, MOV, AVI, MKVなどの動画形式からのフレーム抽出
   - 指定されたフレームレートと最大フレーム数に基づく抽出
   - 3Dモデル生成に適した間隔でのフレーム選択

4. **バッチ処理とマルチスレッディング**
   - 多数のファイルを効率的に処理するための並列処理
   - 進捗状況の追跡と詳細なログ出力
   - 大量のメディアファイルを扱うための最適化

### 実装詳細

- `MediaProcessor`クラスが中心となり、各種メディア形式の処理を管理
- 出力フォーマット（JPG/PNG/TIFF）、最大サイズ、品質などのカスタマイズが可能
- ファイル拡張子による自動検出と適切な処理方法の選択
- 一時ディレクトリを使用した安全な処理と後片付け

## 2. 空間メディア対応拡張モジュール（spatial_processor.py）

このモジュールは、360度カメラやAR/VRデバイスで撮影された空間メディアを処理する機能を提供します。

### 主な機能

1. **Insta360フォーマット対応**
   - `.insp`（Insta360専用静止画形式）の直接処理
   - `.insv`（Insta360専用動画形式）の直接処理
   - FFmpegを利用した変換と処理

2. **360度メディア処理**
   - 等距円筒図法（全天球）画像から6方向（前/右/後/左/上/下）の平面透視投影画像への変換
   - メタデータを使用した360度コンテンツの検出
   - ExifToolを利用した詳細なメタデータ解析

3. **ステレオ（3D）メディア対応**
   - Side-by-Side（左右分割）およびTop-Bottom（上下分割）形式のステレオコンテンツ処理
   - 左右の視点からの画像の分離と個別処理
   - メタデータとファイル名によるステレオフォーマットの自動検出

4. **空間データ処理**
   - XREALなどのAR/VRデバイスからの空間データ処理
   - 空間メタデータの活用

### 実装詳細

- `SpatialMediaProcessor`クラスが中心となり、空間メディアの処理を管理
- 高度な球面座標変換と透視投影アルゴリズムの実装
- ExifToolとFFmpegを利用した複雑なメディア形式の処理
- ステレオ分割と方向別透視投影の柔軟なオプション設定

## 拡張機能の統合

これらの拡張機能は、SimpleSfMのメインアプリケーションに統合され、以下のように利用できます：

1. **ユーザーインターフェース統合**
   - メインメニューとツールバーに専用のインポートオプション
   - 専用ダイアログ（media_dialog.py, spatial_media_dialog.py）を通じた操作
   - 処理設定の詳細なカスタマイズオプション

2. **ワークフロー統合**
   - 拡張機能で処理されたファイルが自動的にSimpleSfMのメインワークフローに統合
   - 出力ディレクトリの画像が直接フォトグラメトリー処理に使用可能
   - 直感的なユーザー体験を維持したスムーズな操作

これらの拡張機能により、SimpleSfMはより多様なソースからの3Dモデル生成が可能になり、一般的なカメラ画像だけでなく、RAWファイル、動画、360度カメラ、AR/VRデバイスなど、様々なデバイスやフォーマットに対応できるようになります。

特に空間メディア拡張は、Insta360やXREALなどの最新の空間撮影デバイスと連携し、空間情報を活用した高品質な3Dモデル生成を可能にします。

---

© 2025 SimpleSfM Team. All rights reserved.

